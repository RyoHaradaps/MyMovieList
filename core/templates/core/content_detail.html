{% extends "core/base.html" %}
{% load custom_tags %}
{% block title %}
{% if tmdb_data %}
{% if tmdb_data.title %}
{{ tmdb_data.title }}
{% elif tmdb_data.name %}
{{ tmdb_data.name }}
{% endif %}
{% else %}
{{ content.title }}
{% endif %}
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row gap-8 bg-gray-900 rounded-xl shadow-xl p-6">
    <!-- Left: Poster & User Status -->
    <div class="w-full md:w-1/4 flex flex-col items-center">
        <img src="{% if tmdb_data and tmdb_data.poster_path %}https://image.tmdb.org/t/p/w500{{ tmdb_data.poster_path }}{% else %}{{ content.poster_url }}{% endif %}"
            alt="{% if tmdb_data %}{% if tmdb_data.title %}{{ tmdb_data.title }}{% elif tmdb_data.name %}{{ tmdb_data.name }}{% else %}{{ content.title }}{% endif %}{% else %}{{ content.title }}{% endif %}"
            class="rounded-lg shadow-2xl w-full mb-6 border-4 border-gray-800">
        {% if user.is_authenticated %}
        <div class="bg-gray-800 p-4 rounded-lg w-full mt-2 shadow-lg">
            <h3 class="font-semibold mb-2 flex items-center"><i class="fa-solid fa-user-check mr-2"></i>Your Status</h3>
            <!-- Example: Show user's status for this content (replace with real data if available) -->
            <div class="mb-2 flex items-center gap-2">
                <span class="bg-blue-700 px-2 py-1 rounded text-xs font-semibold">Watching</span>
                <span class="bg-gray-700 px-2 py-1 rounded text-xs">Eps: 3 / {{ content.episodes }}</span>
                <span class="bg-yellow-600 px-2 py-1 rounded text-xs flex items-center"><i
                        class="fa-solid fa-star mr-1"></i>8</span>
            </div>
            <a href="#edit-status" class="text-blue-400 hover:underline text-xs"><i
                    class="fa-solid fa-pen mr-1"></i>Edit Status</a>
        </div>
        {% endif %}
    </div>

    <!-- Right: Tabs and Content -->
    <div class="w-full md:w-3/4" x-data="{ tab: 'details' }">
        <!-- Tab Bar -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button class="px-4 py-2 font-semibold focus:outline-none border-b-2 transition-all duration-200"
                :class="tab === 'details' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                @click="tab = 'details'">
                <i class="fa-solid fa-circle-info mr-1"></i>Details
            </button>
            <button class="px-4 py-2 font-semibold focus:outline-none border-b-2 transition-all duration-200"
                :class="tab === 'characters' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                @click="tab = 'characters'">
                <i class="fa-solid fa-users mr-1"></i>Cast & Crew
            </button>
            {% if content.content_type and content.content_type != 'movie' or tmdb_data and tmdb_data.first_air_date %}
            <button class="px-4 py-2 font-semibold focus:outline-none border-b-2 transition-all duration-200"
                :class="tab === 'episodes' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                @click="tab = 'episodes'">
                <i class="fa-solid fa-list-ol mr-1"></i>Episodes
            </button>
            {% endif %}
            <button class="px-4 py-2 font-semibold focus:outline-none border-b-2 transition-all duration-200"
                :class="tab === 'related' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                @click="tab = 'related'">
                <i class="fa-solid fa-link mr-1"></i>Related
            </button>
            <button class="px-4 py-2 font-semibold focus:outline-none border-b-2 transition-all duration-200"
                :class="tab === 'videos' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                @click="tab = 'videos'">
                <i class="fa-solid fa-play-circle mr-1"></i>Videos
            </button>
            <button class="px-4 py-2 font-semibold focus:outline-none border-b-2 transition-all duration-200"
                :class="tab === 'share' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400'"
                @click="tab = 'share'">
                <i class="fa-solid fa-share-nodes mr-1"></i>Share
            </button>
        </div>

        <!-- Details Tab -->
        <div x-show="tab === 'details'" class="space-y-4">
            <h1 class="text-3xl font-bold mb-1 flex items-center gap-2">
                <i class="fa-solid fa-film text-blue-400"></i>
                {% if tmdb_data %}
                {% if tmdb_data.title %}
                {{ tmdb_data.title }}
                {% elif tmdb_data.name %}
                {{ tmdb_data.name }}
                {% else %}
                {{ content.title }}
                {% endif %}
                {% else %}
                {{ content.title }}
                {% endif %}
            </h1>
            {% if content.alt_title or content.synonyms %}
            <div class="mb-2 text-gray-400">
                {% if content.alt_title %}
                <div><span class="font-semibold"><i class="fa-solid fa-language mr-1"></i>Alternative Title:</span> {{
                    content.alt_title }}</div>
                {% endif %}
                {% if content.synonyms %}
                <div><span class="font-semibold"><i class="fa-solid fa-book mr-1"></i>Synonyms:</span> {{
                    content.synonyms }}</div>
                {% endif %}
            </div>
            {% endif %}
            <div class="flex flex-wrap gap-3 mb-4">
                {% if not content %}
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-clapperboard" title="Genres"></i>
                    {% for genre in tmdb_data.genres %}
                    {{ genre.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </span>
                {# Hide runtime for series/animatedshows #}
                {% if tmdb_data and tmdb_data.runtime and tmdb_data.title %}
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-circle-info" title="Runtime"></i>
                    {{ tmdb_data.runtime|hours }}h {{ tmdb_data.runtime|minutes }}m
                </span>
                {% endif %}
                {% endif %}
                {% if content and content.content_type == 'movie' %}
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-clapperboard" title="Genres"></i>
                    {% for genre in tmdb_data.genres %}{{ genre.name }}
                    {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </span>
                {# Only show runtime for movies #}
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-circle-info" title="Runtime"></i>
                    {% if tmdb_data.runtime %}
                    {{ tmdb_data.runtime|hours }}h {{ tmdb_data.runtime|minutes }}m
                    {% else %}
                    N/A
                    {% endif %}
                </span>
                {% endif %}
                {% if content.content_type and content.content_type != 'movie' %}
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-clapperboard" title="Content Type"></i> {{ content.content_type|title }}
                </span>
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-circle-info" title="Status"></i> {{ content.status }}
                </span>
                {% endif %}
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-calendar" title="Release Year"></i>
                    {% if tmdb_data %}
                    {% if tmdb_data.release_date %}
                    {{ tmdb_data.release_date|slice:"0:4" }}
                    {% elif tmdb_data.first_air_date %}
                    {{ tmdb_data.first_air_date|slice:"0:4" }}
                    {% elif content.release_year %}
                    {{ content.release_year }}
                    {% endif %}
                    {% else %}
                    {{ content.release_year }}
                    {% endif %}
                </span>
                <span class="bg-gray-700 px-3 py-1 rounded flex items-center gap-1">
                    <i class="fa-solid fa-star text-yellow-400" title="Rating"></i>
                    {% if tmdb_data and tmdb_data.vote_average %}{{ tmdb_data.vote_average }}{% else %}{{ content.rating
                    }}{% endif %}
                </span>
            </div>
            <div class="mb-6">
                <h2 class="font-semibold text-lg mb-1 flex items-center"><i
                        class="fa-solid fa-align-left mr-2"></i>Synopsis</h2>
                <p class="text-gray-200 leading-relaxed">
                    {% if tmdb_data and tmdb_data.overview %}
                    {{ tmdb_data.overview }}
                    {% else %}
                    No synopsis available.
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Characters Tab -->
        <div x-show="tab === 'characters'" class="space-y-4">
            <h2 class="font-semibold text-lg mb-2 flex items-center"><i class="fa-solid fa-users mr-2"></i>Cast
            </h2>
            {% if characters %}
            <div class="relative">
                <button class="carousel-arrow left-0 absolute top-1/2 -translate-y-1/2 z-10"
                    onclick="scrollCarousel('characters-carousel', -1)"><i
                        class="fa-solid fa-chevron-left"></i></button>
                <div id="characters-carousel"
                    class="flex overflow-x-auto gap-4 pb-2 custom-scrollbar scrollbar-hide scroll-smooth snap-x">
                    {% for char in characters %}
                    <div class="bg-gray-800 rounded-lg p-3 flex gap-3 items-center flex-shrink-0 w-64 snap-start">
                        {% if char.profile_path %}
                        <img src="https://image.tmdb.org/t/p/w185{{ char.profile_path }}" alt="{{ char.name }}"
                            class="w-16 h-16 object-cover rounded shadow">
                        {% endif %}
                        <div>
                            <div class="font-bold text-blue-300">{{ char.name }}</div>
                            <div class="text-xs text-gray-400">{{ char.character }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-arrow right-0 absolute top-1/2 -translate-y-1/2 z-10"
                    onclick="scrollCarousel('characters-carousel', 1)"><i
                        class="fa-solid fa-chevron-right"></i></button>
            </div>
            {% else %}
            <div class="text-gray-400">No character data available.</div>
            {% endif %}

            <!-- Crew Carousel below Cast -->
            <h2 class="font-semibold text-lg mb-2 flex items-center"><i class="fa-solid fa-user-tie mr-2"></i>Crew</h2>
            {% if staff %}
            <div class="relative">
                <button class="carousel-arrow left-0 absolute top-1/2 -translate-y-1/2 z-10"
                    onclick="scrollCarousel('staff-carousel', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                <div id="staff-carousel"
                    class="flex overflow-x-auto gap-4 pb-2 custom-scrollbar scrollbar-hide scroll-smooth snap-x">
                    {% for s in staff %}
                    <div class="bg-gray-800 rounded-lg p-3 flex gap-3 items-center flex-shrink-0 w-64 snap-start">
                        {% if s.profile_path %}
                        <img src="https://image.tmdb.org/t/p/w185{{ s.profile_path }}" alt="{{ s.name }}"
                            class="w-16 h-16 object-cover rounded shadow">
                        {% endif %}
                        <div>
                            <div class="font-bold text-blue-300">{{ s.name }}</div>
                            <div class="text-xs text-gray-400">
                                {% if s.jobs %}
                                {{ s.jobs|join:", " }}
                                {% else %}
                                {{ s.job }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-arrow right-0 absolute top-1/2 -translate-y-1/2 z-10"
                    onclick="scrollCarousel('staff-carousel', 1)"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            {% else %}
            <div class="text-gray-400">No staff data available.</div>
            {% endif %}
        </div>

        <!-- Episodes Tab (collapsible season panels) -->
        <div x-show="tab === 'episodes'" class="space-y-4">
            <h2 class="font-semibold text-lg mb-2 flex items-center"><i class="fa-solid fa-list-ol mr-2"></i>Episodes
            </h2>
            {% if seasons and seasons|length > 0 %}
            <div class="relative">
                <div id="seasonsScrollBox" class="space-y-3 max-h-[500px] overflow-y-auto pr-8">
                    {% for season in seasons %}
                    <div x-data="{ open: false }" class="bg-gray-800 rounded-lg">
                        <button @click="open = !open"
                            class="w-full flex items-center justify-between px-4 py-3 focus:outline-none">
                            <div>
                                <span class="text-lg font-bold text-blue-300">{{ season.name }}</span>
                                <span class="text-gray-400 text-sm ml-2">{{ season.overview }}</span>
                            </div>
                            <span>
                                <i :class="open ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'"></i>
                            </span>
                        </button>
                        <div x-show="open" x-transition class="px-4 pb-4">
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-left text-gray-200 text-sm">
                                    <thead>
                                        <tr class="border-b border-gray-700">
                                            <th class="px-2 py-1">#</th>
                                            <th class="px-2 py-1">Title</th>
                                            <th class="px-2 py-1">Overview</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ep in season.episodes %}
                                        <tr class="border-b border-gray-700">
                                            <td class="px-2 py-1 font-bold">{{ ep.episode_number }}</td>
                                            <td class="px-2 py-1">{{ ep.name }}</td>
                                            <td class="px-2 py-1">{{ ep.overview|default:'No overview.' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="scroll-progress hidden" id="seasonsScrollProgress"
                    style="top: 20px; right: 8px; height: 500px;">
                    <div class="scroll-label">SCROLL TO TOP</div>
                    <div class="progress-bar" style="height: 115px;">
                        <div class="bar" id="seasonsScrollBar"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-gray-400">No episode data available.</div>
            {% endif %}
        </div>
        <style>
            .scroll-progress {
                position: absolute;
                right: 8px;
                top: 20px;
                height: 500px;
                display: flex;
                align-items: center;
                z-index: 10;
                cursor: pointer;
                transition: opacity 0.4s ease, transform 0.4s ease;
            }

            .scroll-progress.hidden {
                opacity: 0;
                pointer-events: none;
                transform: translateY(20px);
            }

            .scroll-label {
                writing-mode: vertical-rl;
                transform: rotate(180deg);
                margin-right: 12px;
                font-size: 10px;
                color: #a0a0a0;
                font-weight: 500;
                letter-spacing: 2.5px;
                user-select: none;
            }

            .progress-bar {
                width: 4px;
                height: 115px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                overflow: hidden;
            }

            .progress-bar .bar {
                width: 100%;
                height: 0%;
                background: linear-gradient(180deg, #33ccff, #ff33cc);
                border-radius: 3px;
                transition: height 0.1s linear;
            }

            /* Hide native scrollbar for the seasons scroll box */
            #seasonsScrollBox {
                scrollbar-width: none;
                /* Firefox */
                -ms-overflow-style: none;
                /* IE 10+ */
            }

            #seasonsScrollBox::-webkit-scrollbar {
                display: none;
                /* Chrome, Safari, Opera */
            }
        </style>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const seasonsBox = document.getElementById("seasonsScrollBox");
                const progress = document.getElementById("seasonsScrollProgress");
                const bar = document.getElementById("seasonsScrollBar");
                if (seasonsBox && progress && bar) {
                    seasonsBox.addEventListener("scroll", () => {
                        const scrollTop = seasonsBox.scrollTop;
                        const scrollHeight = seasonsBox.scrollHeight - seasonsBox.clientHeight;
                        const scrollPercent = (scrollTop / scrollHeight) * 100;
                        bar.style.height = scrollPercent + "%";
                        if (scrollTop > 50) {
                            progress.classList.remove("hidden");
                        } else {
                            progress.classList.add("hidden");
                        }
                    });
                    progress.addEventListener("click", () => {
                        seasonsBox.scrollTo({
                            top: 0,
                            behavior: "smooth"
                        });
                    });
                }
            });
        </script>

        <!-- Related Tab -->
        <div x-show="tab === 'related'" class="space-y-4">
            <h2 class="font-semibold text-lg mb-2 flex items-center"><i class="fa-solid fa-link mr-2"></i>Related
                Entries</h2>
            {% if related_entries %}
            <div class="flex overflow-x-auto gap-4 pb-2 custom-scrollbar scrollbar-hide">
                {% for rel in related_entries %}
                <div class="bg-gray-800 rounded-lg shadow-md flex-shrink-0 w-56 p-3 snap-start border border-gray-700">
                    <div class="font-semibold text-blue-300 mb-1 flex items-center gap-1">
                        <i class="fa-solid fa-arrow-right-arrow-left"></i> {{ rel.get_relation_type_display }}
                    </div>
                    <a href="{% url 'content_detail' rel.to_content.pk %}"
                        class="block text-lg font-bold text-blue-400 hover:underline truncate">{{ rel.to_content.title
                        }}</a>
                    {% if rel.to_content.poster_url %}
                    <img src="{{ rel.to_content.poster_url }}" alt="{{ rel.to_content.title }}"
                        class="rounded mt-2 w-full h-32 object-cover">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-gray-400">No related entries found.</div>
            {% endif %}
        </div>

        <!-- Videos Tab -->
        <div x-show="tab === 'videos'" class="space-y-4">
            <h2 class="font-semibold text-lg mb-2 flex items-center"><i class="fa-solid fa-play-circle mr-2"></i>Videos
            </h2>
            {% if videos %}
            <div class="relative">
                <button class="carousel-arrow left-0 absolute top-1/2 -translate-y-1/2 z-10"
                    onclick="scrollCarousel('videos-carousel', -1)"><i class="fa-solid fa-chevron-left"></i></button>
                <div id="videos-carousel"
                    class="flex overflow-x-auto gap-6 pb-2 custom-scrollbar scrollbar-hide scroll-smooth snap-x">
                    {% for video in videos %}
                    {% if video.site == 'YouTube' %}
                    <div class="flex-shrink-0 w-96 snap-start">
                        <div class="font-semibold text-blue-300 mb-1">{{ video.name }} <span
                                class="text-xs text-gray-400">({{ video.type }})</span></div>
                        <div class="aspect-w-16 aspect-h-9 w-full rounded overflow-hidden">
                            <iframe width="100%" height="315" src="https://www.youtube.com/embed/{{ video.key }}"
                                frameborder="0" allowfullscreen class="w-full h-64"></iframe>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <button class="carousel-arrow right-0 absolute top-1/2 -translate-y-1/2 z-10"
                    onclick="scrollCarousel('videos-carousel', 1)"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            {% else %}
            <div class="text-gray-400">No videos available.</div>
            {% endif %}
        </div>

        <!-- Share Tab -->
        <div x-show="tab === 'share'" class="space-y-4">
            <h2 class="font-semibold text-lg mb-2 flex items-center"><i class="fa-solid fa-share-nodes mr-2"></i>Share
            </h2>
            <div class="flex gap-4 items-center">
                <button onclick="navigator.clipboard.writeText(window.location.href)"
                    class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded flex items-center gap-2"><i
                        class="fa-solid fa-link"></i>Copy Link</button>
                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}" target="_blank"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded flex items-center gap-2"><i
                        class="fa-brands fa-twitter"></i>Twitter</a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank"
                    class="bg-blue-700 hover:bg-blue-800 text-white px-3 py-2 rounded flex items-center gap-2"><i
                        class="fa-brands fa-facebook"></i>Facebook</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}